{% extends "base.html" %}

{% block title %}Панель пользователя{% endblock %}

{% block nav_links %}
    <a class="nav-link" href="{{ url_for('user_logs') }}"><i class="fas fa-history"></i> Логи</a>
    <a class="nav-link" href="{{ url_for('set_password') }}"><i class="fas fa-key"></i> Пароль</a>
    <a class="nav-link" href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt"></i> Выйти</a>
    {% if profile and profile.is_admin %}
        <a class="nav-link" href="{{ url_for('admin_dashboard') }}"><i class="fas fa-cog"></i> Админ панель</a>
    {% endif %}
{% endblock %}

{% block content %}
    <div class="container mt-4">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category or 'info' }}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        <h1>Панель пользователя</h1>
        <p>Привет, пользователь {{ profile.telegram_user_id }}!</p>
        {% if profile %}
            <div class="card mb-4">
                <div class="card-header">
                    <h2 class="h5 mb-0">Профиль</h2>
                </div>
                <div class="card-body">
                    <p><strong>OMS:</strong> {{ profile.oms_number }}</p>
                    <p><strong>Дата рождения:</strong> {{ profile.birth_date }}</p>
                </div>
            </div>
        {% endif %}
        {% if not profile.is_admin %}
            <div class="card mb-4">
                <div class="card-header">
                    <h2 class="h5 mb-0">Админ доступ</h2>
                </div>
                <div class="card-body">
                    <form method="post" action="{{ url_for('make_self_admin') }}">
                        <button type="submit" class="btn btn-warning">Стать админом (если нет других админов)</button>
                    </form>
                </div>
            </div>
        {% endif %}
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h2 class="h5 mb-0">Токены</h2>
                {% if token_status is defined and token_status %}
                    {% if token_status == 'expired' %}<span class="badge bg-danger">EXPIRED</span>
                    {% elif token_status == 'soon' %}<span class="badge bg-warning text-dark">SOON</span>
                    {% else %}<span class="badge bg-success">OK</span>{% endif %}
                {% endif %}
            </div>
            <div class="card-body">
                {% if tokens %}
                    <div class="row">
                        <div class="col-md-6">
                            <p class="mb-1"><strong>Access:</strong> <code>{{ tokens.access_token[:28] }}...</code></p>
                            <p class="mb-1"><strong>Refresh:</strong> <code>{{ tokens.refresh_token[:28] }}...</code></p>
                            {% if remaining_seconds is defined and remaining_seconds is not none %}
                                <p class="text-muted small mb-1">Осталось ~ {{ (remaining_seconds // 60) if remaining_seconds>0 else 0 }} мин.</p>
                            {% endif %}
                            {% if last_token_update is defined and last_token_update %}
                                <p class="text-muted small mb-2">Обновлён: {{ last_token_update.strftime('%Y-%m-%d %H:%M:%S') }} UTC</p>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <form method="post" action="{{ url_for('user_update_tokens') }}">
                                <label class="form-label">JSON замена:</label>
                                <textarea name="tokens_json" class="form-control form-control-sm" rows="4" placeholder='{"access_token":"...","refresh_token":"...","expires_in":3600}'></textarea>
                                <div class="form-text">access_token / refresh_token / expires_in (сек)</div>
                                <button type="submit" class="btn btn-sm btn-primary mt-2">Сохранить</button>
                            </form>
                        </div>
                    </div>
                {% else %}
                    <p>Нет токенов. Введите JSON:</p>
                    <form method="post" action="{{ url_for('user_update_tokens') }}">
                        <textarea name="tokens_json" class="form-control form-control-sm" rows="4" placeholder='{"access_token":"...","refresh_token":"...","expires_in":3600}'></textarea>
                        <button type="submit" class="btn btn-sm btn-primary mt-2">Сохранить</button>
                    </form>
                {% endif %}
            </div>
        </div>
        <div class="card mb-4">
            <div class="card-header">
                <h2 class="h5 mb-0">Отслеживаемые врачи</h2>
            </div>
            <div class="card-body">
                {% if tracked %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Имя</th>
                                    <th>Специальность</th>
                                    <th>Активен</th>
                                    <th>Автозапись</th>
                                    <th>Правила</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for t in tracked %}
                                    {% set doctor = doctor_dict.get(t.doctor_api_id) %}
                                    <tr>
                                        <td>{{ t.doctor_api_id }}</td>
                                        <td>{{ doctor.name if doctor else 'Неизвестен' }}</td>
                                        <td>{{ doctor.ar_speciality_name if doctor else 'Неизвестна' }}</td>
                                        <td>
                                            <form method="post" action="{{ url_for('toggle_track', doctor_id=t.doctor_api_id) }}" style="display:inline;">
                                                <button type="submit" class="btn btn-sm {{ 'btn-success' if t.active else 'btn-outline-secondary' }}">{{ 'ON' if t.active else 'OFF' }}</button>
                                            </form>
                                        </td>
                                        <td>
                                            <form method="post" action="{{ url_for('toggle_auto', doctor_id=t.doctor_api_id) }}" style="display:inline;">
                                                <button type="submit" class="btn btn-sm {{ 'btn-success' if t.auto_booking else 'btn-outline-secondary' }}">{{ 'ON' if t.auto_booking else 'OFF' }}</button>
                                            </form>
                                        </td>
                                        <td>{{ t.tracking_rules | format_rules }}</td>
                                        <td>
                                            <a href="{{ url_for('edit_track', doctor_id=t.doctor_api_id) }}" class="btn btn-sm btn-info"><i class="fas fa-edit"></i> Редактировать</a>
                                            <form method="post" action="{{ url_for('delete_track', doctor_id=t.doctor_api_id) }}" style="display:inline;">
                                                <button type="submit" class="btn btn-sm btn-danger"><i class="fas fa-trash"></i> Удалить</button>
                                            </form>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p>Нет отслеживаемых врачей.</p>
                {% endif %}
                <a href="{{ url_for('add_track') }}" class="btn btn-primary"><i class="fas fa-plus"></i> Добавить врача в отслеживание</a>
            </div>
        </div>
        <div class="card mb-4">
            <div class="card-header">
                <h2 class="h5 mb-0">Избранные врачи</h2>
            </div>
            <div class="card-body">
                {% if favorites %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Имя</th>
                                    <th>Специальность</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for f in favorites %}
                                    {% set doctor = doctor_dict.get(f.doctor_api_id) %}
                                    <tr>
                                        <td>{{ f.doctor_api_id }}</td>
                                        <td>{{ doctor.name if doctor else 'Неизвестен' }}</td>
                                        <td>{{ doctor.ar_speciality_name if doctor else 'Неизвестна' }}</td>
                                        <td>
                                            <form method="post" action="{{ url_for('delete_favorite', doctor_id=f.doctor_api_id) }}" style="display:inline;">
                                                <button type="submit" class="btn btn-sm btn-danger">Удалить</button>
                                            </form>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p>Нет избранных врачей.</p>
                {% endif %}
                <a href="{{ url_for('add_favorite') }}" class="btn btn-primary">Добавить врача в избранное</a>
            </div>
        </div>
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h2 class="h5 mb-0">Перенос услуг (кровь / ЭКГ)</h2>
                <a href="{{ url_for('service_tasks') }}" class="btn btn-sm btn-outline-primary">Управление задачами</a>
            </div>
            <div class="card-body">
                {% if shift_tasks %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead><tr><th>ID</th><th>Тип</th><th>LPU фильтр</th><th>Активна</th><th>Статус</th><th>Окна</th></tr></thead>
                        <tbody>
                        {% for s in shift_tasks[:8] %}
                            <tr>
                                <td>{{ s.id }}</td>
                                <td>{{ s.service_type }}</td>
                                <td>{{ s.lpu_substring }}</td>
                                <td>{{ 'ON' if s.active else 'OFF' }}</td>
                                <td>{{ s.last_status or '-' }}</td>
                                <td>
                                    {% if s.allowed_windows %}<small class="text-success">{{ s.allowed_windows|join(', ') }}</small>{% endif %}
                                    {% if s.forbidden_windows %}<div><small class="text-danger">! {{ s.forbidden_windows|join(', ') }}</small></div>{% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                    <p>Нет активных задач переноса. <a href="{{ url_for('service_tasks') }}">Создать</a></p>
                {% endif %}
            </div>
        </div>
    </div>
{% endblock %}