{% extends "base.html" %}

{% block title %}Админ логи{% endblock %}

{% block nav_links %}
    <a class="nav-link" href="{{ url_for('admin_dashboard') }}"><i class="fas fa-home"></i> Назад</a>
    <a class="nav-link" href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt"></i> Выйти</a>
{% endblock %}

{% block content %}
        <h1>Логи всех пользователей</h1>
    <form method="get" class="row g-2 mb-3">
            <div class="col-auto">
                <input type="text" name="user" class="form-control form-control-sm" placeholder="user id" value="{{ selected_user_id if selected_user_id else '' }}">
            </div>
            <div class="col-auto">
                <button type="submit" class="btn btn-sm btn-primary">Фильтр</button>
            </div>
            <div class="col-auto">
                {% if show_all %}
                    <a href="{{ url_for('admin_logs') }}" class="btn btn-sm btn-outline-secondary">Только выбранный</a>
                {% else %}
                    <a href="{{ url_for('admin_logs') }}?all=1" class="btn btn-sm btn-outline-secondary">Все</a>
                {% endif %}
            </div>
        </form>
        <table class="table table-striped table-sm align-middle">
            <thead>
                <tr>
                    {% if show_all %}<th>Пользователь</th>{% endif %}
                    <th>Метка / время (МСК)</th>
                    <th>Действие</th>
                    <th>Детали</th>
                </tr>
            </thead>
            <tbody>
                {% for log in logs %}
                    <tr class="{% if log.status in ['error','fail'] %}table-danger{% elif log.status == 'warning' %}table-warning{% endif %}">
                        {% if show_all %}<td>{{ log.telegram_user_id }}</td>{% endif %}
                        <td class="font-monospace">
                            {% set st = log.status if log.status else 'info' %}
                            {% if st in ['fail'] %}{% set st = 'error' %}{% endif %}
                            {% if st == 'success' %}{% set st = 'success' %}{% elif st == 'warning' %}{% set st = 'warn' %}{% elif st in ['error','fail'] %}{% set st = 'error' %}{% elif st == 'info' %}{% set st = 'info' %}{% endif %}
                            {% set src = log.source if log.source else '?' %}
                            {# Предполагаем что timestamp в UTC - отображаем как МСК #}
                            {% set msk_time = (log.timestamp.replace(tzinfo=namespace.utc) if false else log.timestamp) %}
                            {# Используем pretty_time подготовленную на сервере и явно помечаем МСК #}
                            [{{ st|upper }} {{ src|upper }}] {{ log.pretty_time if log.pretty_time else log.timestamp.strftime('%Y-%m-%d %H:%M:%S') }} (МСК)
                        </td>
                        <td>{{ log.action }}</td>
                        <td class="text-break small">{{ log.details or '' }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% endblock %}