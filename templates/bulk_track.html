{% extends 'base.html' %}
{% block title %}Массовое отслеживание{% endblock %}
{% block content %}
<h4 class="mb-3">Массовое отслеживание</h4>
<p class="text-muted mb-4">Шаги: 1) выберите специальность → 2) выберите адрес (фильтр) → 3) отметьте нужные ресурсы → 4) введите правила → 5) отправьте.</p>
<form method="post" id="bulkTrackForm">
  <div class="row g-4">
    <div class="col-12 col-lg-4">
  <h5 class="mb-2">1. Специальность </span></h5>
      <select id="specialitySelect" class="form-select mb-2">
        <option value="">— выберите специальность —</option>
        {% for sp in specialties %}
          <option value="{{ sp.code }}">{{ sp.name }} ({{ sp.count }})</option>
        {% endfor %}
      </select>
  <div class="small text-muted">Можно пропустить: тогда в списке ниже будут все врачи (всего: {{ total_doctors or 0 }}). Фильтр адреса работает всегда.</div>
      <hr />
      <h5 class="mb-2">2. Фильтр по адресу</h5>
      <input type="text" id="addressFilter" class="form-control mb-2" placeholder="Например: Ф 3" />
      <div class="d-flex gap-2 mb-3">
        <button type="button" id="selectAllVisible" class="btn btn-sm btn-outline-primary">Выбрать все видимые</button>
        <button type="button" id="clearAllVisible" class="btn btn-sm btn-outline-secondary">Снять</button>
      </div>
    </div>
    <div class="col-12 col-lg-5">
      <h5 class="mb-2">3. Ресурсы</h5>
      <div class="border rounded p-2" style="max-height:420px;overflow:auto;">
        <table class="table table-sm table-hover align-middle mb-0">
          <thead>
            <tr class="small"><th style="width:32px;"></th><th>Врач / Адрес</th></tr>
          </thead>
          <tbody id="resourcesBody"></tbody>
        </table>
      </div>
      <div class="mt-2 small text-muted" id="resourcesSummary">0/0 выбрано</div>
    </div>
    <div class="col-12 col-lg-3">
      <h5 class="mb-2">4. Правила</h5>
      <textarea name="rules" id="rulesTextarea" class="form-control mb-2" rows="8" placeholder="понедельник 08:00-12:00, вторник 09:00-13:00"></textarea>
      <div class="form-text mb-3">Через запятую. Примеры:<br><code>понедельник 08:00-12:00</code><br><code>2025-10-05 09:00-11:00</code></div>
      <!-- stop_on_first всегда включён по умолчанию (галочку убрали) -->
      <input type="hidden" name="stop_on_first" value="1" />
      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" value="1" id="autoBooking" name="auto_booking" checked />
        <label class="form-check-label" for="autoBooking">Включить автозапись для всех выбранных</label>
      </div>
      <button type="submit" class="btn btn-primary w-100 mb-2"><i class="fas fa-save"></i> Записать отслеживание</button>
      <div class="small text-muted">Подтверждение теперь внизу страницы.</div>
    </div>
  </div>
  <!-- Bottom confirmation block -->
  <div class="mt-4 pt-3 border-top">
    <h5 class="mb-2">5. Подтверждение</h5>
    <div class="d-flex align-items-center gap-2 mb-2 small">
      <span class="badge bg-secondary" id="summaryBadge">0 выбрано</span>
      <button type="button" class="btn btn-sm btn-outline-primary" id="copyFioRulesBtn">Копировать список</button>
      <button type="button" class="btn btn-sm btn-outline-secondary" id="toggleRawBtn" data-state="hidden">IDs</button>
    </div>
    <div id="selectedBadges" class="mb-2 small" style="min-height:28px;"></div>
    <div id="fioRulesPreview" class="small font-monospace bg-light border rounded p-2 mb-2" style="max-height:120px;overflow:auto; white-space:pre;">(ничего не выбрано)</div>
    <div id="rawContainer" class="mb-2 d-none">
      <textarea name="doctor_ids" id="doctorIdsTextarea" class="form-control form-control-sm" rows="3" readonly placeholder="IDs"></textarea>
    </div>
  </div>
</form>
{% endblock %}

{% block scripts %}
<script id="doctorsData" type="application/json">{{ doctors_json|tojson|safe }}</script>
<script>
  let ALL_DOCTORS = [];
  // Храним выбранные id между перерисовками
  const SELECTED_IDS = new Set();
  // Добавим стили для удобства (динамически)
  (function addRowSelectStyle(){
    const style = document.createElement('style');
    style.textContent = `#resourcesBody tr{cursor:pointer;} #resourcesBody tr.table-active{background:#e7f1ff !important;}`;
    document.head.appendChild(style);
  })();
  (function initData(){
    const el = document.getElementById('doctorsData');
    if (!el) { console.warn('doctorsData script tag not found'); return; }
    console.log('doctorsData text length:', el.textContent.length);
    try { ALL_DOCTORS = JSON.parse(el.textContent) || []; } catch(e){ console.error('Failed to parse doctors JSON', e); }
    console.log('ALL_DOCTORS loaded:', ALL_DOCTORS.length);
    if (ALL_DOCTORS.length) console.log('Sample doctor:', ALL_DOCTORS[0]);
    // Попробуем отрисовать сразу, если элементы уже есть
    try { if (typeof renderResources === 'function') renderResources(); } catch(_e) {}
  })();
  const specialitySelect = document.getElementById('specialitySelect');
  const addressFilter = document.getElementById('addressFilter');
  const resourcesBody = document.getElementById('resourcesBody');
  const doctorIdsTextarea = document.getElementById('doctorIdsTextarea');
  const resourcesSummary = document.getElementById('resourcesSummary');
  const selectAllVisibleBtn = document.getElementById('selectAllVisible');
  const clearAllVisibleBtn = document.getElementById('clearAllVisible');
  const selectedBadges = document.getElementById('selectedBadges');
  const summaryBadge = document.getElementById('summaryBadge');
  // copyIdsBtn убран из упрощённого UI
  const toggleRawBtn = document.getElementById('toggleRawBtn');
  const rawContainer = document.getElementById('rawContainer');
  const rulesTextarea = document.getElementById('rulesTextarea');
  const fioRulesPreview = document.getElementById('fioRulesPreview');
  const copyFioRulesBtn = document.getElementById('copyFioRulesBtn');
  const fioErgoPreview = null; // упразднено
  // Аббревиатуры специальностей (можно расширять)
  const SPEC_ABBR = {
    '69|602': 'ВОП',
    '2028': 'ДЕРМ', '2029': 'ДЕРМ', '2030': 'ДЕРМ', '2032': 'ДЕРМ'
  };
  function recomputeSelected() {
    const ids = [];
    resourcesBody.querySelectorAll('input.resChk:checked').forEach(chk => ids.push(chk.value));
    // Обновляем глобальный набор
    SELECTED_IDS.clear();
    ids.forEach(id => SELECTED_IDS.add(id));
    // Подсветка строк
    resourcesBody.querySelectorAll('tr').forEach(tr => {
      const cb = tr.querySelector('input.resChk');
      if(!cb) return;
      tr.classList.toggle('table-active', cb.checked);
    });
    doctorIdsTextarea.value = ids.join('\n');
  const totalVisible = resourcesBody.querySelectorAll('tr').length;
    resourcesSummary.textContent = `${ids.length}/${totalVisible} выбрано`;
    summaryBadge.textContent = `${ids.length} выбрано`;
    // badges render
    selectedBadges.innerHTML = '';
    ids.forEach(id => {
      const doc = ALL_DOCTORS.find(d => d.id === id);
      const display = doc ? doc.name : id;
      const span = document.createElement('span');
      span.className = 'badge bg-info text-dark';
      span.style.cursor = 'pointer';
      span.title = 'Клик чтобы убрать';
      span.textContent = display;
      span.addEventListener('click', () => {
        const cb = resourcesBody.querySelector(`input.resChk[value="${id}"]`);
        if (cb) { cb.checked = false; recomputeSelected(); }
      });
      selectedBadges.appendChild(span);
    });
    updateFioRulesPreview(ids);
  }
  function abbreviateName(full){
    if(!full) return '';
    const parts = full.trim().split(/\s+/);
    if(!parts.length) return full;
    const lastname = parts[0];
    const initials = parts.slice(1).map(p=> p ? p[0].toUpperCase()+'.' : '').join('');
    return lastname + (initials? '_' + initials : '');
  }
  function buildLines(ids){
    return ids.map(id => {
      const doc = ALL_DOCTORS.find(d => d.id === id);
      return doc ? doc.name : id;
    });
  }
  function updateFioRulesPreview(ids){
    if(!fioRulesPreview) return;
    if (!ids.length) { fioRulesPreview.textContent='(ничего не выбрано)'; return; }
    fioRulesPreview.textContent = buildLines(ids).join('\n');
  }
  function renderResources() {
    const spec = specialitySelect.value;
    const filter = addressFilter.value.trim().toLowerCase();
    resourcesBody.innerHTML = '';
    if (!ALL_DOCTORS.length) {
      const tr = document.createElement('tr');
      tr.innerHTML = '<td colspan="4" class="text-muted small">Нет сохранённых ресурсов</td>';
      resourcesBody.appendChild(tr);
      resourcesSummary.textContent = '0/0 выбрано';
      return;
    }
    const fragment = document.createDocumentFragment();
    const filtered = ALL_DOCTORS.filter(d => {
      if (spec && d.spec_code !== spec) return false;
      if (filter) {
        // Ищем по полноу адресу и короткому названию ЛПУ (short_name), объединяя их
        const fullPart = (d.full_address || '').toLowerCase();
        const shortPart = (d.address || '').toLowerCase();
        const haystack = (fullPart + ' ' + shortPart).trim();
        if (!haystack.includes(filter)) return false;
      }
      return true;
    });
    filtered.forEach(d => {
      const tr = document.createElement('tr');
      const displayAddr = d.address || '';
      const fullAddr = d.full_address || displayAddr;
      const addrLine = displayAddr ? `<div class=\"text-muted small\" title=\"${fullAddr}\">${displayAddr}</div>` : '';
      tr.innerHTML = `
        <td><input type=\"checkbox\" class=\"form-check-input resChk\" value=\"${d.id}\" ${SELECTED_IDS.has(d.id)?'checked':''} /></td>
        <td style=\"max-width:320px;\"><div>${d.name}</div>${addrLine}</td>`;
      fragment.appendChild(tr);
    });
    if (!filtered.length) {
      const tr = document.createElement('tr');
  tr.innerHTML = '<td colspan="2" class="text-muted small">Не найдено по фильтру</td>';
      fragment.appendChild(tr);
    }
    resourcesBody.appendChild(fragment);
    // После перерисовки пересчитаем (сохранённые чекбоксы восстановились)
    recomputeSelected();
  }
  specialitySelect.addEventListener('change', renderResources);
  addressFilter.addEventListener('input', renderResources);
  resourcesBody.addEventListener('change', e => { if (e.target.classList.contains('resChk')) recomputeSelected(); });
  selectAllVisibleBtn.addEventListener('click', () => { resourcesBody.querySelectorAll('input.resChk').forEach(c=> c.checked=true); recomputeSelected(); });
  clearAllVisibleBtn.addEventListener('click', () => { resourcesBody.querySelectorAll('input.resChk').forEach(c=> c.checked=false); recomputeSelected(); });
  toggleRawBtn.addEventListener('click', () => {
    const st = toggleRawBtn.getAttribute('data-state');
    if (st==='hidden') { rawContainer.classList.remove('d-none'); toggleRawBtn.textContent='Скрыть сырой список'; toggleRawBtn.setAttribute('data-state','shown'); }
    else { rawContainer.classList.add('d-none'); toggleRawBtn.textContent='Показать сырой список'; toggleRawBtn.setAttribute('data-state','hidden'); }
  });
  copyFioRulesBtn.addEventListener('click', () => {
    const txt = fioRulesPreview.textContent.trim();
    if(!txt || txt==='(ничего не выбрано)') return;
    navigator.clipboard.writeText(txt).then(()=>{
      const old = copyFioRulesBtn.textContent; copyFioRulesBtn.textContent='Скопировано'; setTimeout(()=> copyFioRulesBtn.textContent=old,1300);
    });
  });
  rulesTextarea.addEventListener('input', () => {
    const ids = doctorIdsTextarea.value ? doctorIdsTextarea.value.split(/\n+/).filter(Boolean) : [];
    updateFioRulesPreview(ids);
  });
  // клики по строке ресурса (не только по чекбоксу)
  resourcesBody.addEventListener('click', (e) => {
    // Если клик по самому чекбоксу – даём стандартному событию change обработаться
    if (e.target.classList && e.target.classList.contains('resChk')) return;
    const tr = e.target.closest('tr');
    if(!tr || !resourcesBody.contains(tr)) return;
    const cb = tr.querySelector('input.resChk');
    if(!cb) return; // служебная строка
    if(window.getSelection && window.getSelection().toString()) return; // выделение текста
    cb.checked = !cb.checked;
    recomputeSelected();
  });
  // initial generation
  updateFioRulesPreview([]);
  renderResources();
</script>
<!-- doctorsData already included above -->
{% endblock %}
