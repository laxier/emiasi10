{% extends 'base.html' %}
{% block title %}{{ cfg.title }} · Админ{% endblock %}
{% block content %}
<div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mb-3">
  <div>
    <h1 class="h4 mb-0">{{ cfg.title }}</h1>
    <small class="text-muted">
      До 500 записей{% if total_found is not none %} · Найдено: {{ total_found }}{% endif %}
    </small>
  </div>
  <form method="get" class="d-flex align-items-center gap-2">
    <div class="input-group input-group-sm" style="width:240px;">
      <input type="text" class="form-control" name="q" placeholder="Поиск..." value="{{ q or '' }}" />
      {% if q %}
        <a class="btn btn-outline-secondary" href="{{ url_for('admin_model_list', model_key=model_key) }}" title="Сброс">
          <i class="fa fa-times"></i>
        </a>
      {% else %}
        <button class="btn btn-outline-secondary" type="submit"><i class="fa fa-search"></i></button>
      {% endif %}
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('admin_dashboard') }}"><i class="fa fa-arrow-left"></i> Назад</a>
      {% if cfg.create and cfg.editable|length > 0 %}
        <a class="btn btn-primary btn-sm" href="{{ url_for('admin_model_create', model_key=model_key) }}"><i class="fa fa-plus"></i> Создать</a>
      {% endif %}
    </div>
  </form>
</div>

<div class="card shadow-sm mb-4">
  <div class="card-body p-2">
    <div class="table-responsive" style="max-height:70vh;">
      <table class="table table-sm table-hover align-middle mb-0">
        <thead class="table-light sticky-top">
          <tr>
            <th style="width:50px;">ID</th>
            {% for field in cfg.editable %}<th>{{ field }}</th>{% endfor %}
            <th style="min-width:260px;">Доп. поля</th>
            <th style="width:100px;">Действия</th>
          </tr>
        </thead>
        <tbody>
        {% for obj in items %}
          <tr>
            <td class="text-muted">{{ obj.id }}</td>
            {% for field in cfg.editable %}
              <td>
                {% set val = (obj|attr(field)) %}
                {% if val is mapping or val is sequence and not val is string %}
                  <code class="small">{{ val }}</code>
                {% else %}
                  {{ val }}
                {% endif %}
              </td>
            {% endfor %}
            <td class="small">
              <div class="row row-cols-1 g-1">
              {% for name,val in obj.__dict__.items() if name not in ['._sa_instance_state','_sa_instance_state','id'] + cfg.editable %}
                {% if model_key == 'doctor' and name == 'resolved_short_address' %}
                  <div><span class="text-secondary">short_addr:</span> {{ val }}</div>
                {% elif not (model_key == 'doctor' and name == 'resolved_short_address') %}
                  <div><span class="text-secondary">{{ name }}:</span>
                    {% if model_key == 'schedule' and name == 'schedule_text' and val %}
                      {% set txt = val %}
                      {% set shown = txt[:180] %}
                      <code title="{{ txt|length }} chars total">{{ shown }}{% if txt|length > 180 %}… ({{ txt|length }}){% endif %}</code>
                    {% elif val is mapping or val is sequence and not val is string %}
                      <code>{{ val }}</code>
                    {% else %}
                      {{ val }}
                    {% endif %}
                  </div>
                {% endif %}
              {% endfor %}
              </div>
            </td>
            <td class="text-nowrap">
              {% if cfg.editable|length > 0 %}
                <a class="btn btn-sm btn-outline-primary" href="{{ url_for('admin_model_edit', model_key=model_key, obj_id=obj.id) }}"><i class="fa fa-pen"></i></a>
              {% else %}
                <span class="text-muted small">—</span>
              {% endif %}
              {% if cfg.delete %}
                <form method="post" action="{{ url_for('admin_model_delete', model_key=model_key, obj_id=obj.id) }}" class="d-inline" onsubmit="return confirm('Удалить?');">
                  <button class="btn btn-sm btn-outline-danger" type="submit"><i class="fa fa-trash"></i></button>
                </form>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}
